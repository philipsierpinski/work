---
title: "HW4"
author: "Philip Sierpinski"
date: "1 december 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r,message=FALSE,warning=FALSE}
library(RSQLite)
library(DBI)
library(tidyverse)
library(dbplyr)
library(plyr)
```

```{r}
#my query for the database.
my_db <- DBI::dbConnect(RSQLite::SQLite(), "../HW_data/system.sqlite")
dbListTables(my_db) #checking tables in my_db
stock <- dbGetQuery(my_db, "SELECT * FROM stock") #to view the data
store <- dbGetQuery(my_db, "SELECT * FROM store") #to view the data

```


```{r}
#my query for butik_ombud in SQL
butik_ombud <- dbGetQuery(my_db, "SELECT Address5 AS county, COUNT(Address5) AS Number, Typ AS Type
                          FROM store
                          GROUP BY Address5,Typ"
                          )
glimpse(butik_ombud)

```


```{r}
#my query for assortment in SQL
assortment <- dbGetQuery(my_db, "SELECT Nr AS Store, Address5 AS county, Address4 as City, stock.Varugrupp AS Product, stock.AntalProdukter
FROM store JOIN stock
ON store.Nr = stock.ButikNr")


```

If there are more stores than agents we get a higher "ratio".

```{r}
type_ombud<- butik_ombud%>%
  filter(Type=="Ombud")

type_butik<- butik_ombud%>%
  filter(Type=="Butik")%>%
  left_join(type_ombud, by="county")%>%
  mutate(Antal_Butiker = Number.x, Antal_Ombud = Number.y)%>%
  select(county,Antal_Butiker,Antal_Ombud)%>%
  mutate(county = as.factor(county))%>%
  mutate(Ratio = Antal_Butiker / Antal_Ombud)
levels(type_butik$county) <- c("Blekinge", "Dalarnas", "Gotlands", "Gävleborgs", "Hallands", "Jämtlands", "Jönköpings", "Kalmar", "Kronobergs", "Norrbottens", "Skåne", "Stockholms", "Södermanlands", "Uppsala", "Värmlands", "Västerbottens", "Västernorrlands", "Västmanlands","Västra Götalands", "Örebro", "Östergötlands")


counties <- read_csv("../HW_data/counties.csv")
counties<-counties %>%
  mutate(county = as.factor(LnNamn))%>%
  select(-LnNamn)%>%
  left_join(type_butik, by="county")



ggplot(counties) + geom_polygon(aes(x = long, y = lat, group = group, fill = Ratio)) +
    coord_fixed() +
    theme_bw()

```





##Komplettering - Product Patterns


```{r}
my_scale <- function(x)((x-mean(x))/sd(x))

assortment_wide <- assortment %>%
  group_by(Store)%>%
  mutate_if(is.numeric, funs(. / sum(AntalProdukter))) %>% #räknar ut andelen
  spread(key = Product,value = AntalProdukter)

assortment_wide[is.na(assortment_wide)] <- 0 #replace NA's med 0


x<-assortment_wide[,4:21]%>% #scalar alla produkter
  mutate_all(my_scale)

SVD <- svd(x)

u <- SVD$u
colnames(u) <- paste0("col" ,c(1:ncol(u)))

u<- as.data.frame(u)

decomp <- assortment_wide %>% 
  bind_cols(assortment_wide, u[, 1:2])

decomp_graph_cols <- ggplot(data=decomp, aes(col1,col2))  +
  geom_point()

decomp_graph_cols #plottar 

decomp_identify <- decomp %>% 
  filter(col1 >= 0.1 & col2>=0.3) #identifierar outliers 



```


The outliers as seen are:

```{r}
#identifying outliers
decomp_identify
```




```{r}
clusters <- decomp %>%
  ungroup(Store) %>% 
  select(col1, col2) %>%
  dist() %>%
  hclust()
plot(clusters)

clusters_grouping <- cutree(clusters, 6) ##delar in i 6 clusters
assortment2 <- cbind(decomp, ClusterGroup = factor(clusters_grouping)) 


ggplot(data=assortment2,aes(col1,col2, color = ClusterGroup)) +
  geom_point()

```

Applying hierarchical clustering to the data divides the set into distinct groups. I'd say the colored clusters do agree pretty well with the visual clusters in the previous plot. ClusterGroup 3 (green) does however seem to have several "mini-clusters" within itself.

```{r}
x_tran <- t(x)

SVD_tran <- svd(x_tran)

u_tran <- SVD_tran$u
u_tran <- as.data.frame(u_tran)

rownames(u_tran) <- rownames(x_tran) #behövs för att kunna plotta heatmapen korrekt senare

u_tran2 <- SVD_tran$u  #behövs för att sortera produkter enligt cluster group
u_tran2 <- as.data.frame(u_tran2)



clusters_tran2 <- u_tran2 %>%
  select(V1, V2) %>%
  dist() %>%
  hclust()

clusters_tran <- u_tran %>% 
  select(V1, V2) %>%
  dist() %>%
  hclust()

clusters_grouping_tran <- cutree(clusters_tran, 5) # ser indelning
```


```{r}


clusterordning<- cutree(clusters_tran2, 5)
col_names <- colnames(assortment_wide[4:21]) #column names for heatmap


korrekt_ordning<- as.data.frame(col_names) #to make sure col names are ordered correctly
korrekt_ordning <- korrekt_ordning %>% 
  mutate(cluster=clusterordning) %>% 
  arrange(cluster)


```


```{r}
type_and_clusters <- decomp %>%
  select(col_names,Store) %>% 
  gather(col_names, key = Product, value = andel) %>% 
  mutate(skalerad_andel = my_scale(andel), Product = factor(Product, levels=(korrekt_ordning$col_names)))
#gör om Product till factor för att kunna ordna dem enligt cluster grupp
type_and_clusters %>% 
  ggplot(aes(x = Store, y = Product)) + geom_tile(aes(fill = skalerad_andel)) + scale_fill_gradient2() + xlab("Stores") + scale_y_discrete(labels = paste0(korrekt_ordning$col_names, 
                                  as.character(korrekt_ordning$cluster)))


```

In the heatmap above you can see the what cluster each type of drink belongs to. You can also tell what type of drinks are most available in stores. Rött vin, Vitt vin and Öl represent a large portion of most stores inventory.



```{r}
#plotting dendrogram of transpose of x
plot(clusters_tran)
```

